<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Brain Tumor Multi-task Analysis</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header-title { color: #2c3e50; font-weight: 700; margin-bottom: 30px; }
        
        /* Khung chứa ảnh */
        .image-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }

        .image-title {
            font-weight: 600;
            color: #555;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border: 2px dashed #dde2e6;
            display: none; /* Ẩn mặc định */
        }
        
        .placeholder-text {
            color: #adb5bd;
            font-style: italic;
        }

        /* Phần kết quả JSON */
        .json-box {
            background: #2d3436;
            color: #00cec9;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }

        /* Loading Spinner */
        #loading {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            z-index: 9999; background: rgba(255, 255, 255, 0.8);
            display: none;
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px;
            position: absolute; top: 50%; left: 50%;
            margin: -30px 0 0 -30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-custom { width: 100%; font-weight: 600; padding: 10px; }
    </style>
</head>
<body>

    <div class="container main py-5">
        <h2 class="text-center header-title">Brain Tumor Segmentation & Classification</h2>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="image-container">
                    <div class="image-title">Original MRI Scan</div>
                    <img src="" id="photo" class="preview-img">
                    <span id="placeholder-input" class="placeholder-text">No image uploaded</span>
                    <canvas style="display:none;" id="canvas"></canvas>
                </div>
                
                <div class="mt-3">
                    <form id="upload-data">
                        <input type="file" id="fileinput" accept="image/*" style="display:none;"/>
                        <div class="row">
                            <div class="col-6">
                                <button type="button" class="btn btn-primary btn-custom" id="uload">
                                    <i class="fa fa-upload"></i> Upload MRI
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-success btn-custom" id="send">
                                    Analyze
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="url" value="../predict"/>
                    </form>
                </div>
            </div>

            <div class="col-md-6">
                <div class="image-container mb-3">
                    <div class="image-title">Segmentation Mask Result</div>
                    <div id="result-image-box">
                        <span class="placeholder-text">Result will appear here</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-dark text-white">
                        Classification Report
                    </div>
                    <div class="card-body p-0">
                        <div class="jsonRes json-box">Waiting for prediction...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading"><div class="loader"></div></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>
        var base_data = "";

        // Hàm gửi request
        function sendRequest(base64Data){
            if(base64Data != "" && base64Data != null){
                var url = $("#url").val();
                $("#loading").show();
                
                $.ajax({
                    url : url,
                    type: "post",
                    cache: false,
                    async: true,
                    crossDomain: true,
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin':'*'
                    },
                    data: JSON.stringify({image: base64Data}),
                    success: function(res){
                        $("#loading").hide();
                        
                        // 1. Xử lý Segmentation Mask (Ảnh trả về)
                        $("#result-image-box").html("");
                        try {
                            // Giả sử backend trả về res[1].image là base64 mask
                            // Nếu backend trả về cấu trúc khác, hãy sửa dòng này
                            var imageData = res[1].image; 
                            if(imageData.length > 10){
                                $("#result-image-box").append(
                                    "<img class='preview-img' style='display:block;' src='data:image/png;base64," + imageData + "' alt='Segmentation Mask' />"
                                );
                            }
                        } catch(e){
                            $("#result-image-box").html("<span class='text-danger'>Error displaying mask</span>");
                        }

                        // 2. Xử lý Classification Result (JSON)
                        // Hiển thị JSON đẹp hơn
                        $(".jsonRes").html("<pre>" + JSON.stringify(res[0], undefined, 2) + "</pre>");
                    },
                    error: function(err){
                        $("#loading").hide();
                        $(".jsonRes").html("<span class='text-danger'>Error calling API. Check console.</span>");
                        console.error(err);
                    }
                });
            } else {
                alert("Please upload an MRI image first.");
            }
        }

        $(document).ready(function(){
            // Sự kiện nút Upload
            $('#uload').click(function() {
                $('#fileinput').trigger('click');
            });

            // Sự kiện chọn file
            $("#fileinput").change(function(){
                if (this.files && this.files[0]){
                    var reader = new FileReader();
                    reader.onload = function (e){
                        var url = e.target.result;
                        var img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.onload = function(){
                            var canvas = document.createElement('CANVAS');
                            var ctx = canvas.getContext('2d');
                            canvas.height = this.height;
                            canvas.width = this.width;
                            ctx.drawImage(this, 0, 0);
                            
                            // Lấy base64 sạch (bỏ header data:image...)
                            base_data = canvas.toDataURL('image/png', 1.0).replace(/^data:image.+;base64,/, '');
                            canvas = null;
                        };
                        img.src = url;
                        
                        // Hiển thị ảnh lên UI
                        $('#photo').attr('src', url).show();
                        $('#placeholder-input').hide();
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Sự kiện nút Predict
            $('#send').click(function(){
                sendRequest(base_data);
            });
        });
    </script>
</body>
</html>